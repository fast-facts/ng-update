{"version":3,"file":"main.js","sourceRoot":"","sources":["../src/main.ts"],"names":[],"mappings":"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","sourcesContent":["import * as core from '@actions/core';\nimport * as github from '@actions/github';\nimport * as path from 'path';\nimport { GithubService } from './github.service';\nimport { NgUpdateService } from './ngupdate.service';\nimport { GitService } from './git.service';\nimport { Helpers } from './helpers';\n\n// tslint:disable-next-line: no-floating-promises\n(async () => {\n  try {\n    const context = github.context;\n    const repo = `${context.repo.owner}/${context.repo.repo}`;\n    const repoToken = core.getInput('repo-token');\n    const baseBranch = core.getInput('base-branch');\n    const remoteUrl = `https://x-access-token:${repoToken}@github.com/${repo}`;\n    const repoDir = process.env.GITHUB_WORKSPACE || ''; // TODO: if empty, manually checkout project\n    const authorName = 'ng-update[bot]';\n    const authorEmail = `ng-update@users.noreply.github.com`;\n    const projectPath = path.normalize(path.join(repoDir, core.getInput('project-path')));\n\n    const gbClient = new github.GitHub(repoToken);\n    const ngService = new NgUpdateService(projectPath);\n    const gitService = new GitService(repoDir);\n    const gbService = new GithubService(gbClient, context);\n\n    core.info(`ðŸ¤– Checking if received Github event should be ignored...`);\n    if (gbService.shouldIgnoreEvent(baseBranch)) {\n      return;\n    }\n\n    if (Helpers.isFolderEmpty(repoDir)) {\n      const fetchDepth = core.getInput('fetch-depth');\n      core.info(`ðŸ¤– Repo directory at: '${repoDir}' is empty. Checking out from: '${remoteUrl}'...`);\n      await gitService.clone(remoteUrl, fetchDepth);\n    }\n\n    await core.group(`ðŸ¤– Initializing git config at: '${repoDir}'`, async () => {\n      await gitService.init(remoteUrl, authorName, authorEmail);\n    });\n\n    await core.group(`ðŸ¤– Moving git head to base branch: ${baseBranch}`, async () => {\n      await gitService.checkoutBranch(baseBranch);\n    });\n\n    const ngFilePath = path.join(projectPath, 'angular.json');\n    const isNgProject = await Helpers.isFileExists(ngFilePath);\n    if (!isNgProject) {\n      core.error(`ðŸ¤– Could not detect an Angular CLI project under \"${projectPath}\", exiting`);\n      return;\n    }\n\n    const prTitle = core.getInput('pr-title');\n    const prBranchPrefix = core.getInput('pr-branch-prefix');\n\n    await core.group(`ðŸ¤– Prerequisites are done. Trying to 'ng update' your code now...`, async () => {\n      const ngUpdateResult = await ngService.runUpdate();\n\n      if (ngUpdateResult.packages.length > 0 && await gitService.hasChanges()) {\n        const prBody = Helpers.getPrBody(core.getInput('pr-body'), ngUpdateResult.ngUpdateOutput);\n        const prLabels = Helpers.getPrAssignees(core.getInput('pr-labels'));\n        const prAssignees = Helpers.getPrAssignees(core.getInput('pr-assignees'));\n        const prReviewers = Helpers.getPrReviewers(core.getInput('pr-reviewers'));\n\n        const ngUpdateSha1 = await gitService.shortenSha1(Helpers.computeSha1(ngUpdateResult));\n        const prBranch = `${prBranchPrefix.substring(0, prBranchPrefix.lastIndexOf('-'))}-${ngUpdateSha1}`;\n\n        core.info(`ðŸ¤– PR branch will be: ${prBranch}`);\n        const remotePrBranchExists = await gitService.remoteBranchExists(prBranch);\n\n        await core.group(`ðŸ¤– Moving git head to pr branch: ${prBranch}`, async () => {\n          await gitService.cleanCheckoutBranch(prBranch, baseBranch, remotePrBranchExists);\n        });\n\n        await core.group(`ðŸ¤– Committing changes to branch: ${prBranch}`, async () => {\n          await gitService.commit(prTitle);\n        });\n\n        await core.group(`ðŸ¤– Pushing changes to pr branch: ${prBranch}`, async () => {\n          await gitService.push(prBranch, remotePrBranchExists); // will updated existing pr\n        });\n\n        let prNumber = await gbService.getOpenPR(baseBranch, prBranch);\n\n        if (prNumber) {\n          core.info(`ðŸ¤– PR from branch '${prBranch}' to '${baseBranch}' already existed (#${prNumber}). It's been simply updated.`);\n        } else {\n          await core.group(`ðŸ¤– Creating PR from branch '${prBranch}' to '${baseBranch}'`, async () => {\n            prNumber = await gbService.createPR(baseBranch, prBranch, prTitle, prBody, prAssignees, prReviewers, prLabels);\n          });\n        }\n\n        if (prNumber) {\n          core.setOutput('pr-number', `'${prNumber}'`);\n        }\n      } else {\n        core.info(`ðŸ¤– Running 'ng update' has produced no change in your code, you must be up-to-date already ðŸ‘!`);\n      }\n\n      core.setOutput('ng-update-result', JSON.stringify(ngUpdateResult.packages));\n    });\n\n    const deleteClosedPRBranches = core.getInput('delete-closed-pr-branches') === 'true';\n    if (deleteClosedPRBranches) {\n      await core.group(`ðŸ¤– Deleting branches related to closed PRs created by this action...`, async () => {\n        await gbService.deleteClosedPRsBranches(baseBranch, prBranchPrefix, prTitle);\n      });\n    }\n  } catch (error) {\n    core.setFailed(error.message);\n  }\n})();"]}